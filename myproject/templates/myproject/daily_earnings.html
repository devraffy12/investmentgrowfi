{% extends 'myproject/dashboard_base.html' %}


{% block title %}Daily Earnings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
            <div class="sidebar p-3">
                <h5 class="text-white mb-4">
                    <i class="fas fa-chart-bar"></i> Reports
                </h5>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="{% url 'daily_earnings' %}">
                        <i class="fas fa-calendar-day"></i> Daily Earnings
                    </a>
                    <a class="nav-link" href="{% url 'monthly_report' %}">
                        <i class="fas fa-calendar-alt"></i> Monthly Report
                    </a>
                    <a class="nav-link" href="{% url 'investment_performance' %}">
                        <i class="fas fa-chart-line"></i> Performance
                    </a>
                    <a class="nav-link" href="{% url 'dashboard' %}">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </nav>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="main-content p-4">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2><i class="fas fa-calendar-day"></i> Daily Earnings Report</h2>
                                <p class="text-muted">Track your daily investment returns</p>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" onclick="printReport()">
                                    <i class="fas fa-print"></i> Print Report
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-calendar-day fa-2x text-primary mb-2"></i>
                                <h5>Today's Earnings</h5>
                                <h3 class="text-primary">₱{{ today_earnings|floatformat:2 }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-calendar-week fa-2x text-success mb-2"></i>
                                <h5>This Week</h5>
                                <h3 class="text-success">₱{{ week_earnings|floatformat:2 }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-calendar-alt fa-2x text-warning mb-2"></i>
                                <h5>This Month</h5>
                                <h3 class="text-warning">₱{{ month_earnings|floatformat:2 }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center">
                            <div class="card-body">
                                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                <h5>Total Earnings</h5>
                                <h3 class="text-info">₱{{ total_earnings|floatformat:2 }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Filter -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <form method="get" id="dateFilterForm">
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label class="form-label">From Date</label>
                                            <input type="date" class="form-control" name="from_date" value="{{ request.GET.from_date }}">
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">To Date</label>
                                            <input type="date" class="form-control" name="to_date" value="{{ request.GET.to_date }}">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-primary w-100">Filter</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6>Quick Filters</h6>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-secondary" onclick="setDateFilter('today')">Today</button>
                                    <button class="btn btn-outline-secondary" onclick="setDateFilter('week')">This Week</button>
                                    <button class="btn btn-outline-secondary" onclick="setDateFilter('month')">This Month</button>
                                    <button class="btn btn-outline-secondary" onclick="setDateFilter('all')">All Time</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Earnings Chart -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-area"></i> Daily Earnings Chart</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="earningsChart" height="100"></canvas>
                                {{ chart_labels|json_script:"chart-labels" }}
                                {{ chart_data|json_script:"chart-data" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Earnings Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="fas fa-table"></i> Daily Earnings Details</h5>
                                <div>
                                    <span class="badge bg-primary">{{ daily_payouts.count }} Records</span>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if daily_payouts %}
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="earningsTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Investment Plan</th>
                                                    <th>Day Number</th>
                                                    <th>Amount Earned</th>
                                                    <th>Investment Amount</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for payout in daily_payouts %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ payout.payout_date|date:"M d, Y" }}</strong><br>
                                                        <small class="text-muted">{{ payout.payout_date|date:"g:i A" }}</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">{{ payout.investment.plan.name }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">Day {{ payout.day_number }}/30</span>
                                                    </td>
                                                    <td>
                                                        <strong class="text-success">₱{{ payout.amount|floatformat:2 }}</strong>
                                                    </td>
                                                    <td>
                                                        ₱{{ payout.investment.amount|floatformat:2 }}
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">Received</span>
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'investment_detail' payout.investment.id %}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i> View
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Pagination -->
                                    {% if is_paginated %}
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination justify-content-center">
                                            {% if page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page=1">First</a>
                                                </li>
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                                </li>
                                            {% endif %}
                                            
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                                            </li>
                                            
                                            {% if page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                                </li>
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                    {% endif %}
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                                        <h4>No Earnings Data</h4>
                                        <p class="text-muted">You haven't received any daily payouts yet.</p>
                                        <a href="{% url 'investment_plans' %}" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Start Investing
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Earnings Chart
document.addEventListener('DOMContentLoaded', function() {
    var chartLabels = JSON.parse(document.getElementById('chart-labels').textContent || '[]');
    var chartData = JSON.parse(document.getElementById('chart-data').textContent || '[]');
    var ctx = document.getElementById('earningsChart').getContext('2d');
    var earningsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Daily Earnings (₱)',
                data: chartData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value.toFixed(2);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Earnings: ₱' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });
});

// Date filter functions
function setDateFilter(period) {
    var today = new Date();
    var fromDate, toDate;
    if (period === 'today') {
        fromDate = toDate = today.toISOString().split('T')[0];
    } else if (period === 'week') {
        var weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay());
        fromDate = weekStart.toISOString().split('T')[0];
        toDate = today.toISOString().split('T')[0];
    } else if (period === 'month') {
        fromDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        toDate = today.toISOString().split('T')[0];
    } else if (period === 'all') {
        fromDate = '';
        toDate = '';
    }
    document.querySelector('input[name="from_date"]').value = fromDate;
    document.querySelector('input[name="to_date"]').value = toDate;
    document.getElementById('dateFilterForm').submit();
}

// Print function
function printReport() {
    window.print();
}

// Export to Excel function
function exportToExcel() {
    if (typeof XLSX === 'undefined') {
        alert('Excel export is not available. Please ensure XLSX library is loaded.');
        return;
    }
    var table = document.getElementById('earningsTable');
    var workbook = XLSX.utils.table_to_book(table);
    XLSX.writeFile(workbook, 'daily_earnings_report.xlsx');
}
</script>

<style>
@media print {
    .sidebar, .btn, .card-header .btn {
        display: none !important;
    }
    .main-content {
        margin-left: 0 !important;
    }
}
</style>
{% endblock %}
