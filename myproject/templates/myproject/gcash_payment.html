{% extends 'myproject/dashboard_base.html' %}
{% load static %}

{% block title %}GCash Payment GrowFi{% endblock %}

{% block content %}
<div class="gcash-payment-container">
    <!-- Header -->
    <div class="payment-header">
        <div class="back-button">
            <a href="{% url 'deposit' %}" class="btn-back">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
        <div class="header-content">
            <img src="{% static 'GrowFi.png' %}" alt="GrowFi" class="logo">
            <h2>Complete Payment</h2>
            <p>Secure payment powered by GCash</p>
        </div>
    </div>

    <!-- Payment Details Card -->
    <div class="payment-details-card">
        <div class="payment-amount">
            <h3>Amount to Pay</h3>
            <div class="amount-display">₱{{ amount|floatformat:2 }}</div>
        </div>
        
        <div class="payment-info">
            <div class="info-row">
                <span class="label">Reference ID:</span>
                <span class="value">{{ reference_id }}</span>
            </div>
            <!-- GCash number removed as requested -->
            <div class="info-row" style="display: none;">
                <span class="label">GCash Number:</span>
                <span class="value">***HIDDEN***</span>
            </div>
            <div class="info-row">
                <span class="label">Merchant:</span>
                <span class="value">GrowFi Investment</span>
            </div>
            <div class="info-row">
                <span class="label">Payment Method:</span>
                <span class="value">
                    <i class="fas fa-mobile-alt"></i>
                    GCash
                </span>
            </div>
        </div>
    </div>

    <!-- Payment Instructions -->
    <div class="instructions-card">
        <h3>
            <i class="fas fa-info-circle"></i>
            How to Pay
        </h3>
        <div class="instruction-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <strong>Open GCash App</strong>
                    <p>Launch your GCash mobile app</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <strong>Send Money</strong>
                    <p>Go to "Send Money" and enter mobile number: <strong></strong></p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <strong>Enter Details</strong>
                    <p>Amount: ₱{{ amount|floatformat:2 }}<br>
                    Reference: {{ reference_id }}</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <strong>Confirm Payment</strong>
                    <p>Review and confirm your transaction</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <!-- Mobile App Button -->
        <button type="button" class="btn-open-gcash" onclick="openGCashApp()">
            <i class="fas fa-mobile-alt"></i>
            <span>Open GCash App</span>
        </button>
        
        <!-- Manual Confirmation -->
        <button type="button" class="btn-manual-confirm" onclick="showManualConfirmation()">
            <i class="fas fa-check"></i>
            <span>I've Completed Payment</span>
        </button>
    </div>

    <!-- Manual Confirmation Form (Hidden) -->
    <div class="manual-confirmation-card" id="manualConfirmCard" style="display: none;">
        <h3>
            <i class="fas fa-receipt"></i>
            Confirm Your Payment
        </h3>
        <form method="post" action="{% url 'deposit' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="amount" value="{{ amount }}">
            <input type="hidden" name="reference_id" value="{{ reference_id }}">
            
            <div class="form-group">
                <label for="gcash_reference">GCash Reference Number</label>
                <input type="text" id="gcash_reference" name="gcash_reference" 
                       class="form-control" placeholder="Enter GCash reference number" required>
            </div>
            
            <div class="form-group">
                <label for="gcash_number">Your GCash Number</label>
                <input type="text" id="gcash_number" name="gcash_number" 
                       class="form-control" placeholder="09xxxxxxxxx" required>
            </div>
            
            <div class="form-group">
                <label for="proof_of_payment">Proof of Payment (Screenshot)</label>
                <input type="file" id="proof_of_payment" name="proof_of_payment" 
                       class="form-control" accept="image/*" required>
            </div>
            
            <button type="submit" class="btn-submit-proof">
                <i class="fas fa-upload"></i>
                Submit Payment Proof
            </button>
        </form>
    </div>

    <!-- Timer -->
    <div class="payment-timer">
        <i class="fas fa-clock"></i>
        <span>Payment expires in: </span>
        <span id="timer">15:00</span>
    </div>
</div>

<style>
.gcash-payment-container {
    max-width: 430px;
    margin: 0 auto;
    padding: 12px 16px 80px;
    background: #f8fafc;
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Arial, sans-serif;
    min-height: 100vh;
}

.payment-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding: 16px 0;
}

.btn-back {
    color: #4a5568;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}

.header-content {
    text-align: center;
    flex: 1;
}

.header-content .logo {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    margin-bottom: 8px;
}

.header-content h2 {
    font-size: 20px;
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 4px;
}

.header-content p {
    font-size: 14px;
    color: #718096;
    margin: 0;
}

.payment-details-card,
.instructions-card,
.manual-confirmation-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.payment-amount {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 20px;
}

.payment-amount h3 {
    font-size: 16px;
    font-weight: 600;
    color: #4a5568;
    margin: 0 0 12px;
}

.amount-display {
    font-size: 32px;
    font-weight: 800;
    color: #00A86B;
    margin: 0;
}

.payment-info .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f7fafc;
}

.payment-info .info-row:last-child {
    border-bottom: none;
}

.info-row .label {
    font-size: 14px;
    color: #718096;
    font-weight: 500;
}

.info-row .value {
    font-size: 14px;
    color: #1a202c;
    font-weight: 600;
}

.instructions-card h3 {
    font-size: 16px;
    font-weight: 700;
    color: #2d3748;
    margin: 0 0 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.instruction-steps {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.step {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.step-number {
    width: 32px;
    height: 32px;
    background: #00A86B;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
}

.step-content strong {
    font-size: 14px;
    font-weight: 700;
    color: #1a202c;
    display: block;
    margin-bottom: 4px;
}

.step-content p {
    font-size: 13px;
    color: #718096;
    margin: 0;
    line-height: 1.4;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.btn-open-gcash,
.btn-manual-confirm,
.btn-submit-proof {
    width: 100%;
    padding: 16px 20px;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-open-gcash {
    background: linear-gradient(135deg, #00A86B, #059669);
    color: white;
    box-shadow: 0 4px 16px rgba(0, 168, 107, 0.3);
}

.btn-open-gcash:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 168, 107, 0.4);
}

.btn-manual-confirm {
    background: #f8fafc;
    color: #4a5568;
    border: 2px solid #e2e8f0;
}

.btn-manual-confirm:hover {
    background: #edf2f7;
    border-color: #cbd5e0;
}

.btn-submit-proof {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
}

.payment-timer {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 12px;
    padding: 12px 16px;
    text-align: center;
    color: #dc2626;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Notification animations */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// Timer functionality
let timeLeft = 15 * 60; // 15 minutes in seconds

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
        alert('Payment session expired. Please try again.');
        window.location.href = "{% url 'deposit' %}";
        return;
    }
    
    timeLeft--;
}

// Update timer every second
setInterval(updateTimer, 1000);

function openGCashApp() {
    const amount = "{{ amount }}";
    const reference = "{{ reference_id }}";
    const gcashNumber = "***HIDDEN***"; // Number removed as requested
    
    // Multiple deep link formats for better compatibility
    const deepLinks = [
        `gcash://pay?amount=${amount}&mobile=${gcashNumber}&name=GrowFi Investment&message=Deposit ${reference}`,
        `gcash://send?amount=${amount}&recipient=${gcashNumber}&recipient_name=GrowFi Investment&reference=${reference}`,
        `gcash://transfer?amount=${amount}&to=${gcashNumber}&note=${reference}`,
        `gcash://sendmoney?amount=${amount}&mobile=${gcashNumber}&message=${reference}`
    ];
    
    // Check if mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Try each deep link
        let linkIndex = 0;
        
        function tryNextLink() {
            if (linkIndex < deepLinks.length) {
                const currentLink = deepLinks[linkIndex];
                console.log(`Trying deep link ${linkIndex + 1}:`, currentLink);
                
                // Create iframe to attempt app launch
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = currentLink;
                document.body.appendChild(iframe);
                
                // Remove iframe after attempt
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
                
                linkIndex++;
                
                // Try next link after 2 seconds
                if (linkIndex < deepLinks.length) {
                    setTimeout(tryNextLink, 2000);
                }
            }
        }
        
        // Start attempting links
        tryNextLink();
        
        // Show notification
        showNotification('Opening GCash app...', 'info');
        
        // Fallback instructions after 8 seconds
        setTimeout(() => {
            showFallbackInstructions();
        }, 8000);
        
    } else {
        // Desktop - show manual instructions (number removed)
        alert(`Please open your GCash mobile app and complete the payment with reference: ${reference}`);
    }
}

function showNotification(message, type) {
    // Remove existing notifications
    const existing = document.querySelectorAll('.notification-popup');
    existing.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'notification-popup';
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'info' ? '#3b82f6' : '#10b981'};
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            font-weight: 600;
            animation: slideIn 0.3s ease-out;
        ">
            <i class="fas fa-${type === 'info' ? 'info-circle' : 'check-circle'}" style="margin-right: 8px;"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }
    }, 4000);
}

function showFallbackInstructions() {
    const fallbackDiv = document.createElement('div');
    fallbackDiv.innerHTML = `
        <div style="
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 0.5s ease-out;
        ">
            <h4 style="color: #92400e; margin: 0 0 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle"></i>
                GCash App Not Opening?
            </h4>
            <p style="color: #92400e; margin: 0 0 16px; font-weight: 600;">
                Please manually open your GCash app and follow these steps:
            </p>
            <ol style="color: #92400e; margin: 0; padding-left: 20px; font-weight: 500;">
                <li style="margin-bottom: 8px;">Open GCash app</li>
                <li style="margin-bottom: 8px;">Tap "Send Money"</li>
                <li style="margin-bottom: 8px;">Contact support for payment details</li>
                <li style="margin-bottom: 8px;">Enter amount: <strong>₱{{ amount }}</strong></li>
                <li style="margin-bottom: 8px;">Add message/reference: <strong>{{ reference_id }}</strong></li>
                <li>Complete the payment</li>
            </ol>
        </div>
    `;
    
    // Insert before action buttons
    const actionButtons = document.querySelector('.action-buttons');
    actionButtons.parentNode.insertBefore(fallbackDiv, actionButtons);
}

function showManualConfirmation() {
    const card = document.getElementById('manualConfirmCard');
    card.style.display = 'block';
    card.scrollIntoView({ behavior: 'smooth' });
}

// Auto-focus on reference input when manual form is shown
document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const card = document.getElementById('manualConfirmCard');
                if (card.style.display === 'block') {
                    setTimeout(() => {
                        document.getElementById('gcash_reference').focus();
                    }, 100);
                }
            }
        });
    });
    
    observer.observe(document.getElementById('manualConfirmCard'), {
        attributes: true
    });
});
</script>
{% endblock %}