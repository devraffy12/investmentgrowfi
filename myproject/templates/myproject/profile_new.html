{% extends 'myproject/dashboard_base.html' %}
{% load static %}

{% block title %}My Profile InvestPH{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Profile Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="profile-hero-card">
                <div class="hero-background"></div>
                <div class="hero-content">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center mb-4 mb-md-0">
                            <div class="profile-picture-container">
                                {% if profile.profile_picture %}
                                    <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" 
                                         class="profile-picture">
                                {% else %}
                                    <div class="profile-picture-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                                <div class="profile-status">
                                    {% if profile.is_verified %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% else %}
                                        <i class="fas fa-clock text-warning"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="profile-info">
                                <h2 class="profile-name">{{ user.get_full_name|default:user.username }}</h2>
                                <p class="profile-email">{{ user.email }}</p>
                                <div class="profile-badges">
                                    {% if profile.is_verified %}
                                        <span class="badge-verified">
                                            <i class="fas fa-shield-check"></i> Verified Account
                                        </span>
                                    {% else %}
                                        <span class="badge-pending">
                                            <i class="fas fa-clock"></i> Pending Verification
                                        </span>
                                    {% endif %}
                                    <span class="badge-member">
                                        <i class="fas fa-calendar"></i> Member since {{ user.date_joined|date:"M Y" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <div class="stat-value">₱{{ profile.balance|floatformat:2 }}</div>
                                    <div class="stat-label">Account Balance</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ total_referrals }}</div>
                                    <div class="stat-label">Total Referrals</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">₱{{ referral_earnings|floatformat:2 }}</div>
                                    <div class="stat-label">Referral Earnings</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Information Form -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-edit"></i> Edit Profile Information</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Personal Information</h6>
                                
                                <div class="mb-3">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name" 
                                           value="{{ user.first_name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name" 
                                           value="{{ user.last_name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ user.email }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone_number" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           value="{{ profile.phone_number }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <textarea class="form-control" id="address" name="address" rows="3">{{ profile.address }}</textarea>
                                </div>
                            </div>
                            
                            <!-- Document Upload -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-upload"></i> Document Upload</h6>
                                
                                <div class="mb-3">
                                    <label for="profile_picture" class="form-label">Profile Picture</label>
                                    <input type="file" class="form-control" id="profile_picture" name="profile_picture" 
                                           accept="image/*">
                                    {% if profile.profile_picture %}
                                        <div class="form-text text-success">
                                            <i class="fas fa-check"></i> Current: {{ profile.profile_picture.name }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="valid_id" class="form-label">Valid ID</label>
                                    <input type="file" class="form-control" id="valid_id" name="valid_id" 
                                           accept="image/*,.pdf">
                                    {% if profile.valid_id %}
                                        <div class="form-text text-success">
                                            <i class="fas fa-check"></i> Current: {{ profile.valid_id.name }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Upload a clear photo of your government-issued ID</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="proof_of_address" class="form-label">Proof of Address</label>
                                    <input type="file" class="form-control" id="proof_of_address" name="proof_of_address" 
                                           accept="image/*,.pdf">
                                    {% if profile.proof_of_address %}
                                        <div class="form-text text-success">
                                            <i class="fas fa-check"></i> Current: {{ profile.proof_of_address.name }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Upload utility bill or bank statement</div>
                                </div>
                                
                                <!-- Verification Status -->
                                <div class="alert {% if profile.is_verified %}alert-success{% else %}alert-warning{% endif %}">
                                    {% if profile.is_verified %}
                                        <i class="fas fa-check-circle"></i>
                                        <strong>Account Verified!</strong><br>
                                        Your account has been successfully verified.
                                    {% else %}
                                        <i class="fas fa-clock"></i>
                                        <strong>Verification Pending</strong><br>
                                        Please upload all required documents for account verification.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Account Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Username:</strong></td>
                                    <td>{{ user.username }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Member Since:</strong></td>
                                    <td>{{ user.date_joined|date:"F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Login:</strong></td>
                                    <td>{{ user.last_login|date:"F d, Y g:i A" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Account Status:</strong></td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Referral Code:</strong></td>
                                    <td>
                                        <code id="referralCode">{{ user.username }}</code>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyReferralCode()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Referrals:</strong></td>
                                    <td>{{ total_referrals }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Active Referrals:</strong></td>
                                    <td>{{ active_referrals }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Referral Earnings:</strong></td>
                                    <td class="text-success fw-bold">₱{{ referral_earnings|floatformat:2 }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    navigator.clipboard.writeText(referralCode).then(function() {
        showToast('Referral code copied to clipboard!', 'success');
    });
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.role = 'alert';
    toastElement.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toastElement);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1080';
    document.body.appendChild(container);
    return container;
}
</script>

<style>
.profile-picture-container {
    position: relative;
    display: inline-block;
}

.card {
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn {
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.table-borderless td {
    padding: 0.5rem 0;
}

@media (max-width: 768px) {
    .container {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .card-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}
