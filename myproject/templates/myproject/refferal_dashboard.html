{% extends 'myproject/base.html' %}

{% block title %}Referral Dashboard InvestPH{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-tachometer-alt"></i> Referral Dashboard
            </h1>
            <p class="text-muted">Track your referral performance and earnings</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'referral_link' %}" class="btn btn-success me-2">
                <i class="fas fa-link"></i> Get Link
            </a>
            <a href="{% url 'referral_history' %}" class="btn btn-outline-primary">
                <i class="fas fa-history"></i> History
            </a>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h3 class="mb-0" id="totalReferrals">0</h3>
                    <p class="mb-0">Total Referrals</p>
                    <small class="opacity-75">Lifetime referrals made</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-user-check fa-3x mb-3"></i>
                    <h3 class="mb-0" id="activeReferrals">0</h3>
                    <p class="mb-0">Active Referrals</p>
                    <small class="opacity-75">Currently investing</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-coins fa-3x mb-3"></i>
                    <h3 class="mb-0" id="totalCommissions">₱0</h3>
                    <p class="mb-0">Total Commissions</p>
                    <small class="opacity-75">All-time earnings</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-day fa-3x mb-3"></i>
                    <h3 class="mb-0" id="monthlyEarnings">₱0</h3>
                    <p class="mb-0">This Month</p>
                    <small class="opacity-75">Current month earnings</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Commission Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="commissionChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Referral Sources</h5>
                </div>
                <div class="card-body">
                    <canvas id="sourceChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-primary w-100 h-100" onclick="shareReferralLink()">
                                <i class="fas fa-share-alt fa-2x mb-2"></i>
                                <div>Share Link</div>
                            </button>
                        </div>
                        
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-success w-100 h-100" onclick="copyReferralLink()">
                                <i class="fas fa-copy fa-2x mb-2"></i>
                                <div>Copy Link</div>
                            </button>
                        </div>
                        
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-info w-100 h-100" onclick="downloadQRCode()">
                                <i class="fas fa-qrcode fa-2x mb-2"></i>
                                <div>QR Code</div>
                            </button>
                        </div>
                        
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-warning w-100 h-100" onclick="requestWithdrawal()">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <div>Withdraw</div>
                            </button>
                        </div>
                        
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-secondary w-100 h-100" onclick="exportReport()">
                                <i class="fas fa-file-export fa-2x mb-2"></i>
                                <div>Export</div>
                            </button>
                        </div>
                        
                        <div class="col-md-2 col-6 mb-3">
                            <button class="btn btn-dark w-100 h-100" onclick="openReferralGuide()">
                                <i class="fas fa-book fa-2x mb-2"></i>
                                <div>Guide</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities & Leaderboard -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-activity"></i> Recent Activity</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="recentActivityList">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                            <div class="text-muted">Loading activities...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-trophy"></i> Top Referrers</h5>
                </div>
                <div class="card-body">
                    <div id="leaderboardList">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                            <div class="text-muted">Loading leaderboard...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Tiers -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-layer-group"></i> Referral Tier System</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <i class="fas fa-bronze fa-2x text-secondary mb-2"></i>
                                    <h6>Bronze Tier</h6>
                                    <p class="small text-muted">0-9 Referrals</p>
                                    <div class="fw-bold">5% Commission</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-award fa-2x text-warning mb-2"></i>
                                    <h6>Silver Tier</h6>
                                    <p class="small text-muted">10-24 Referrals</p>
                                    <div class="fw-bold">7% Commission</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-medal fa-2x text-warning mb-2"></i>
                                    <h6>Gold Tier</h6>
                                    <p class="small text-muted">25-49 Referrals</p>
                                    <div class="fw-bold">10% Commission</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-crown fa-2x text-primary mb-2"></i>
                                    <h6>Diamond Tier</h6>
                                    <p class="small text-muted">50+ Referrals</p>
                                    <div class="fw-bold">15% Commission</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Tier Progress -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Your Progress: <strong id="currentTier">Bronze Tier</strong></span>
                            <span class="text-muted" id="nextTierInfo">7 more referrals to Silver</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="tierProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Modal -->
<div class="modal fade" id="withdrawalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-money-bill-wave"></i> Request Withdrawal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="withdrawalForm">
                    <div class="mb-3">
                        <label class="form-label">Available Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="text" class="form-control" id="availableBalance" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Withdrawal Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" class="form-control" name="amount" id="withdrawalAmount" 
                                   min="100" step="0.01" required>
                        </div>
                        <div class="form-text">Minimum withdrawal: ₱100</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" name="payment_method" required>
                            <option value="gcash">GCash</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="paypal">PayPal</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Account Details</label>
                        <textarea class="form-control" rows="3" name="account_details" 
                                  placeholder="Enter your account number, name, etc." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitWithdrawal()">
                    <i class="fas fa-paper-plane"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Referral Guide Modal -->
<div class="modal fade" id="referralGuideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-book"></i> Referral Success Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-lightbulb"></i> Tips for Success</h6>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item">
                                <strong>Be Authentic:</strong> Share your genuine experience with InvestPH
                            </li>
                            <li class="list-group-item">
                                <strong>Use Multiple Channels:</strong> Share on Facebook, WhatsApp, Instagram, etc.
                            </li>
                            <li class="list-group-item">
                                <strong>Provide Value:</strong> Explain the benefits and answer questions
                            </li>
                            <li class="list-group-item">
                                <strong>Be Consistent:</strong> Regular sharing leads to better results
                            </li>
                            <li class="list-group-item">
                                <strong>Follow Up:</strong> Check on your referrals and provide support
                            </li>
                        </ul>
                        
                        <h6><i class="fas fa-share-alt"></i> Best Sharing Practices</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Social Media</h6>
                                        <p class="small">Post testimonials, screenshots of earnings, and success stories</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Personal Network</h6>
                                        <p class="small">Talk to friends, family, and colleagues about the opportunity</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-chart-line"></i> Tracking Your Progress</h6>
                        <p>Use the analytics in your dashboard to track which sharing methods work best and optimize your strategy accordingly.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{% url 'referral_link' %}" class="btn btn-primary">
                    <i class="fas fa-link"></i> Get My Link
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let commissionChart, sourceChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    initializeCharts();
    
    // Auto-refresh every 5 minutes
    setInterval(loadDashboardData, 300000);
});

function loadDashboardData() {
    fetch('/api/referral-dashboard/')
        .then(response => response.json())
        .then(data => {
            updateStats(data.stats);
            updateCharts(data.chart_data);
            updateRecentActivity(data.recent_activity);
            updateLeaderboard(data.leaderboard);
            updateTierProgress(data.tier_info);
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            showDefaultData();
        });
}

function updateStats(stats) {
    document.getElementById('totalReferrals').textContent = stats?.total_referrals || 0;
    document.getElementById('activeReferrals').textContent = stats?.active_referrals || 0;
    document.getElementById('totalCommissions').textContent = '₱' + (stats?.total_commissions || 0);
    document.getElementById('monthlyEarnings').textContent = '₱' + (stats?.monthly_earnings || 0);
}

function initializeCharts() {
    // Commission Chart
    const commissionCtx = document.getElementById('commissionChart').getContext('2d');
    commissionChart = new Chart(commissionCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Daily Commissions',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value;
                        }
                    }
                }
            }
        }
    });

    // Source Chart
    const sourceCtx = document.getElementById('sourceChart').getContext('2d');
    sourceChart = new Chart(sourceCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#6f42c1',
                    '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateCharts(chartData) {
    // Update commission chart
    if (chartData?.commission_data) {
        commissionChart.data.labels = chartData.commission_data.dates || [];
        commissionChart.data.datasets[0].data = chartData.commission_data.amounts || [];
        commissionChart.update();
    }

    // Update source chart
    if (chartData?.source_data) {
        sourceChart.data.labels = chartData.source_data.labels || [];
        sourceChart.data.datasets[0].data = chartData.source_data.data || [];
        sourceChart.update();
    }
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivityList');
    
    if (!activities || activities.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-activity fa-2x text-muted mb-2"></i>
                <div class="text-muted">No recent activity</div>
                <small>Start sharing your referral link to see activities</small>
            </div>
        `;
        return;
    }
    
    container.innerHTML = activities.map(activity => `
        <div class="d-flex align-items-center py-2 border-bottom">
            <div class="me-3">
                <i class="fas fa-${activity.icon} text-${activity.color} fa-lg"></i>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold">${activity.title}</div>
                <small class="text-muted">${activity.description}</small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">${activity.amount}</div>
                <small class="text-muted">${activity.time}</small>
            </div>
        </div>
    `).join('');
}

function updateLeaderboard(leaderboard) {
    const container = document.getElementById('leaderboardList');
    
    if (!leaderboard || leaderboard.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-trophy fa-2x text-muted mb-2"></i>
                <div class="text-muted">No data available</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = leaderboard.map((user, index) => `
        <div class="d-flex align-items-center py-2 ${index < leaderboard.length - 1 ? 'border-bottom' : ''}">
            <div class="me-3">
                <span class="badge bg-${index === 0 ? 'warning' : index === 1 ? 'secondary' : 'dark'} rounded-pill">
                    ${index + 1}
                </span>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold">${user.name}</div>
                <small class="text-muted">${user.referrals} referrals</small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">₱${user.commissions}</div>
            </div>
        </div>
    `).join('');
}

function updateTierProgress(tierInfo) {
    if (!tierInfo) return;
    
    document.getElementById('currentTier').textContent = tierInfo.current_tier || 'Bronze Tier';
    document.getElementById('nextTierInfo').textContent = tierInfo.next_tier_info || '';
    
    const progress = document.getElementById('tierProgress');
    progress.style.width = (tierInfo.progress_percentage || 0) + '%';
    progress.className = `progress-bar bg-${tierInfo.tier_color || 'secondary'}`;
}

function showDefaultData() {
    updateStats({});
    updateRecentActivity([]);
    updateLeaderboard([]);
    updateTierProgress({});
}

// Quick Actions
function shareReferralLink() {
    if (navigator.share) {
        navigator.share({
            title: 'Join InvestPH',
            text: 'Start earning daily returns with InvestPH!',
            url: document.getElementById('mainReferralLink')?.value || window.location.origin + '/register?ref=' + {{ user.id|default:1 }}
        });
    } else {
        window.location.href = '{% url "referral_link" %}';
    }
}

function copyReferralLink() {
    const link = document.getElementById('mainReferralLink')?.value || 
                  window.location.origin + '/register?ref=' + {{ user.id|default:1 }};
    
    navigator.clipboard.writeText(link).then(() => {
        showToast('Referral link copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy link', 'error');
    });
}

function downloadQRCode() {
    window.location.href = '{% url "referral_link" %}#qr-code';
}

function requestWithdrawal() {
    // Load available balance
    fetch('/api/referral-balance/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('availableBalance').value = data.available_balance || '0.00';
            new bootstrap.Modal(document.getElementById('withdrawalModal')).show();
        })
        .catch(error => {
            console.error('Error loading balance:', error);
            showToast('Error loading balance', 'error');
        });
}

function submitWithdrawal() {
    const form = document.getElementById('withdrawalForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    fetch('/api/request-withdrawal/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('withdrawalModal')).hide();
            showToast('Withdrawal request submitted successfully!', 'success');
            form.reset();
            loadDashboardData(); // Refresh data
        } else {
            showToast(data.message || 'Error submitting withdrawal request', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error submitting withdrawal request', 'error');
    });
}

function exportReport() {
    window.open('/api/export-referral-report/', '_blank');
}

function openReferralGuide() {
    new bootstrap.Modal(document.getElementById('referralGuideModal')).show();
}

function refreshActivity() {
    loadDashboardData();
    showToast('Dashboard refreshed!', 'info');
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.role = 'alert';
    toastElement.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toastElement);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1080';
    document.body.appendChild(container);
    return container;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.progress {
    height: 8px;
}

.btn i.fa-2x {
    display: block;
}

@media (max-width: 768px) {
    .display-5 {
        font-size: 2rem;
    }
    
    .btn .fa-2x {
        font-size: 1.5em;
    }
}

/* Loading animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}
